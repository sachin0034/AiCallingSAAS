<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Layout - Mazer Admin Dashboard</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/css/bootstrap.css" />

    <link
      rel="stylesheet"
      href="assets/vendors/perfect-scrollbar/perfect-scrollbar.css"
    />
    <link
      rel="stylesheet"
      href="assets/vendors/bootstrap-icons/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="assets/css/app.css" />
    <link
      rel="shortcut icon"
      href="assets/images/favicon.svg"
      type="image/x-icon"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        width: 100%;
      }
      .profile-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
      }

      .burger-btn {
        display: flex;
        align-items: center;
      }

      .dropdown-menu {
        min-width: 150px;
        text-align: center;
      }
      .dropdown-item {
        display: flex;
        align-items: center;
      }

      .dropdown-item i {
        margin-right: 8px; /* Adds space between the icon and text */
      }

      .dropdown-divider {
        border: none;
        height: 0.5px;
        background-color: #e9ecef;
        margin: 0.5rem 0;
        width: calc(100% - 1rem);
        margin-left: auto;
        margin-right: auto;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <div id="sidebar" class="active">
        <div class="sidebar-wrapper active">
          <div class="sidebar-header">
            <div class="d-flex justify-content-between">
              <div class="logo">
                <a href="index.html"
                  ><img src="assets/images/logo/logo.png" alt="Logo" srcset=""
                /></a>
              </div>
              <div class="toggler">
                <a href="#" class="sidebar-hide d-xl-none d-block"
                  ><i class="bi bi-x bi-middle"></i
                ></a>
              </div>
            </div>
          </div>
          <div class="sidebar-menu">
            <ul class="menu">
              <li class="sidebar-title">Menu</li>

              <li class="sidebar-item">
                <a href="index.html" class="sidebar-link">
                  <i class="bi bi-grid-fill"></i>
                  <span>Dashboard</span>
                </a>
              </li>
              <div id="admin-subuser-features" style="display: none">
                <li class="sidebar-item">
                  <a href="single-call.html" class="sidebar-link">
                    <i class="bi bi-telephone-fill"></i>
                    <span>Single Call</span>
                  </a>
                </li>

                <li class="sidebar-item active">
                  <a href="bulk-call.html" class="sidebar-link">
                    <i class="bi bi-stack"></i>
                    <span>Bulk Call</span>
                  </a>
                </li>
                <li class="sidebar-item">
                  <a href="call-logs.html" class="sidebar-link">
                    <i class="bi bi-journal-text"></i>
                    <span>Call Logs</span>
                  </a>
                </li>

              </div>
              <div id="admin-super_admin" style="display: none">
                <li class="sidebar-item">
                  <a href="users.html" class="sidebar-link">
                    <i class="bi bi-envelope-fill"></i>
                    <span>Users</span>
                  </a>
                </li>
                <li class="sidebar-item">
                  <a href="appointment.html" class="sidebar-link">
                    <i class="bi bi-calendar-check-fill"></i>
                    <span>Appointment</span>
                  </a>
                </li>
                <li class="sidebar-item" style="display: none;" id="edit-config">
                  <a href="Edit-Config.html" class="sidebar-link">
                    <i class="bi bi-calendar-check-fill"></i>
                    <span>Connect Twilio</span>
                  </a>
                </li>


                <div id="bulk-email-sms" style="display: none">
                  <li class="sidebar-item">
                    <a href="bulk-call-email.html" class="sidebar-link">
                      <i class="fa-solid fa-envelope"></i>
                      <span>Send Bulk Email</span>
                    </a>
                  </li>
                  <li class="sidebar-item">
                    <a href="bulk-sms.html" class="sidebar-link">
                      <i class="fa-solid fa-comments"></i>
                      <span>Send Bulk SMS</span>
                    </a>
                  </li>
                </div>
                

                <li class="sidebar-item" style="display: none;" id="send-config">
                  <a href="sendgrid-config.html" class="sidebar-link">
                    <i class="bi bi-calendar-check-fill"></i>
                    <span>Connect SendGrid</span>
                  </a>
                </li>

              </div>
            </ul>
          </div>
        </div>
      </div>
      <div id="main">
        <header
          class="dashboard-header d-flex align-items-center justify-content-between px-3 py-2"
        >
          <a href="#" class="burger-btn d-block d-xl-none">
            <i class="bi bi-justify fs-3"></i>
          </a>

          <!-- Profile Image and Dropdown Container -->
          <div class="dropdown d-flex ms-auto">
            <img
              src="./assets/images/faces/profile-pic.jpg"
              alt="Profile"
              class="profile-img dropdown-toggle"
              id="profileDropdown"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            />
            <ul
              class="dropdown-menu dropdown-menu-end"
              aria-labelledby="profileDropdown"
              id="dropdownMenu"
            >
              <li>
                <a class="dropdown-item" href="profile.html">
                  <i class="fa-solid fa-user"></i> Profile
                </a>
              </li>
              <li></li>
              <li>
                <a class="dropdown-item" href="#" id="logout-btn">
                  <i class="fa-solid fa-right-from-bracket"></i> Log Out
                </a>
              </li>
            </ul>
          </div>
        </header>

        <div class="row">
          <div class="col-12 col-md-6 order-md-1 order-last">
            <h3>Make Bulk Call</h3>
            <button onclick="downloadSampleFile()" class="btn btn-primary float-end">
              Download Sample File
            </button>
          </div>
          <div class="col-12 col-md-6 order-md-2 order-first">
          
            <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
              <ol class="breadcrumb">
                <li class="breadcrumb-item">
                  <a href="index.html">Dashboard</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                  Bulk Call
                </li>
              </ol>
            </nav>
          </div>
        </div>

          <!-- Basic Horizontal form layout section start -->
          <!-- Bulk Call Form -->
          <section id="bulk-horizontal-layouts" class="container mt-5">
            <div class="row justify-content-center">
              <div class="col-md-15">
                <div class="card">
                  <div class="card-content">
                    <div class="card-body">
                      <form class="form form-horizontal" id="bulk-call-form">
                        <div class="form-body">
                          <div class="row">
                            <div class="col-md-4">
                              <label>CSV File Upload</label>
                            </div>
                            <div class="col-md-8 form-group">
                              <input
                                type="file"
                                id="file-upload"
                                class="form-control"
                                name="file"
                                accept=".xlsx"
                              />
                            </div>
                            <div class="form-group">
                              <label for="category">Select a Category</label>
                              <select
                                id="category"
                                class="form-control"
                                required
                              >
                              <option value="" disabled selected>
                                Select an option
                              </option>
                              <option value="Home Sellers">Home Sellers</option>
                              <option value="Home Buyers">Home Buyers</option>
                              <option value="Real Estate Investor / Wholesaler">
                                Real Estate Investor / Wholesaler
                              </option>
                              <option value="Custom">Custom</option>
                              </select>
                            </div>

                            <!-- Custom value input, hidden initially -->
                            <div
                              class="form-group"
                              id="customField"
                              style="display: none"
                            >
                              <label for="customValue"
                                >Enter Custom Value</label
                              >
                              <input
                                type="text"
                                id="customValue"
                                class="form-control"
                                placeholder="Enter your custom value"
                              />
                            </div>
                            <div class="col-md-4">
                              <label>Select Language</label>
                            </div>
                            <div class="col-md-8 form-group">
                              <select class="form-control" id="language">
                                <option value="">Select Language</option>
                                <option value="bg">Bulgarian</option>
                                <option value="ca">Catalan</option>
                                <option value="cs">Czech</option>
                                <option value="da">Danish</option>
                                <option value="da-DK">Danish (Denmark)</option>
                                <option value="de">German</option>
                                <option value="de-CH">
                                  German (Switzerland)
                                </option>
                                <option value="el">Greek</option>
                                <option value="en">English</option>
                                <option value="en-AU">
                                  English (Australia)
                                </option>
                                <option value="en-GB">English (UK)</option>
                                <option value="en-IN">English (India)</option>
                                <option value="en-NZ">
                                  English (New Zealand)
                                </option>
                                <option value="en-US">English (US)</option>
                                <option value="es">Spanish</option>
                                <option value="es-419">
                                  Spanish (Latin America)
                                </option>
                                <option value="es-LATAM">
                                  Spanish (LATAM)
                                </option>
                                <option value="et">Estonian</option>
                                <option value="fi">Finnish</option>
                                <option value="fr">French</option>
                                <option value="fr-CA">French (Canada)</option>
                                <option value="hi">Hindi</option>
                                <option value="hi-Latn">Hindi (Latin)</option>
                                <option value="hu">Hungarian</option>
                                <option value="id">Indonesian</option>
                                <option value="it">Italian</option>
                                <option value="ja">Japanese</option>
                                <option value="ko">Korean</option>
                                <option value="ko-KR">
                                  Korean (South Korea)
                                </option>
                                <option value="lt">Lithuanian</option>
                                <option value="lv">Latvian</option>
                                <option value="ms">Malay</option>
                                <option value="multi">
                                  Multiple Languages
                                </option>
                                <option value="nl">Dutch</option>
                                <option value="nl-BE">Dutch (Belgium)</option>
                                <option value="no">Norwegian</option>
                                <option value="pl">Polish</option>
                                <option value="pt">Portuguese</option>
                                <option value="pt-BR">
                                  Portuguese (Brazil)
                                </option>
                                <option value="ro">Romanian</option>
                                <option value="ru">Russian</option>
                                <option value="sk">Slovak</option>
                                <option value="sv">Swedish</option>
                                <option value="sv-SE">Swedish (Sweden)</option>
                                <option value="ta">Tamil</option>
                                <option value="taq">Tamasheq</option>
                                <option value="th">Thai</option>
                                <option value="th-TH">Thai (Thailand)</option>
                                <option value="tr">Turkish</option>
                                <option value="uk">Ukrainian</option>
                                <option value="vi">Vietnamese</option>
                                <option value="zh">Chinese</option>
                                <option value="zh-CN">
                                  Chinese (Simplified)
                                </option>
                                <option value="zh-Hans">
                                  Chinese (Simplified Han)
                                </option>
                                <option value="zh-Hant">
                                  Chinese (Traditional Han)
                                </option>
                                <option value="zh-TW">Chinese (Taiwan)</option>
                              </select>
                            </div>
                            <div
                              class="col-sm-12 d-flex justify-content-end mt-3"
                            >
                              <button
                                type="button"
                                onclick="processBulkCalls()"
                                class="btn btn-primary me-1 mb-1"
                              >
                                Submit
                              </button>
                              <button
                                type="reset"
                                class="btn btn-light-secondary me-1 mb-1"
                              >
                                Reset
                              </button>
                            </div>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                <div id="call-results"></div>
                <!-- Display call results here -->
              </div>
            </div>
          </section>
          <!-- // Basic Horizontal form layout section end -->
        </div>
      </div>
    </div>
    <script src="assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="assets/js/main.js"></script>
    <script src="loader.js"></script>

    <!-- Ensure JavaScript containing processBulkCalls function loads properly -->
    <script>
      const categorySelect = document.getElementById("category");
      const customField = document.getElementById("customField");
      const customValueInput = document.getElementById("customValue");
      categorySelect.addEventListener("change", function () {
        if (categorySelect.value === "Custom") {
          customField.style.display = "block"; // Show custom input if "Custom" is selected
        } else {
          customField.style.display = "none"; // Hide custom input for predefined options
        }
      });
      const logoutBtn = document.getElementById("logout-btn");

      logoutBtn.addEventListener("click", () => {
        // Remove the JWT token from localStorage
        console.log("click");
        localStorage.removeItem("token");

        // Redirect the user to the login page

        window.location.href = "login.html";
      });

      function downloadSampleFile() {
    window.location.href = "https://aicalling-demo.onrender.com/api/auth/download-call";
  }

      async function validateToken() {
        const token = localStorage.getItem("token");

        if (!token) {
          // If no token, redirect to login page
          window.location.href = "login.html";
          return;
        }
        showLoader();
        try {
          const response = await fetch(
            // "https://aicalling-osdb.onrender.com/api/auth/validate",
            "https://aicalling-demo.onrender.com/api/auth/validate",
         //   "http://localhost:3000/api/auth/validate",
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            }
          );
          hideLoader();
          if (!response.ok) {
            throw new Error("Token validation failed");
          }

          const data = await response.json();

          const profileImg = document.getElementById("profileDropdown");
          if (data.data.profileImage && data.data.profileImage.buffer) {
            console.log("Come");
            const base64String = arrayBufferToBase64(
              data.data.profileImage.buffer.data
            );
            const mimeType = data.data.profileImage.contentType;
            profileImg.src = `data:${mimeType};base64,${base64String}`;
          } else {
            console.log("Using default profile image");
          }

          if (!data.valid) {
            // If token is not valid, redirect to login page
            window.location.href = "login.html";
          }
          const role = data.role;
          const editConfig = document.getElementById("edit-config");
          const sendConfig = document.getElementById("send-config");
          if(role === "admin")
          {
               editConfig.style.display="block"
               sendConfig.style.display="block"

          }
          if (role === "admin" || role === "super_admin") {
            document.getElementById("admin-super_admin").style.display =
              "block";
          }
          if (
            role === "admin" ||
            role === "subuser" ||
            role === "super_admin"
          ) {
            document.getElementById("admin-subuser-features").style.display =
              "block";
          }
          
          //console.log(role);

          if (role === "super_admin" || role === "admin" || role === "subuser") {
  document.getElementById("admin-subuser-features").style.display = "block";
  document.getElementById("bulk-email-sms").style.display = "block"; 
}


          if (
            role === "admin" ||
            role === "subuser" ||
            role === "super_admin"
          ) {
            const dropdownMenu = document.getElementById("dropdownMenu");

            const adminItems = `

          
          `;

            // Insert admin items before the logout button
            dropdownMenu.insertAdjacentHTML("beforeend", adminItems);
          }

          if (role === "admin") {
            const dropdownMenu = document.getElementById("dropdownMenu");

            const adminItems = `
             <li>
              <a class="dropdown-item" href="add-member.html">
                <i class="fa-solid fa-comments"></i> Add Member
              </a>
            <li>

            </li>
          `;

            // Insert admin items before the logout button
            dropdownMenu.insertAdjacentHTML("beforeend", adminItems);
          }

          if (role === "admin" || role === "user") {
            const dropdownMenu = document.getElementById("dropdownMenu");

            const adminItems = `
      <li>
      <a class="dropdown-item" href="buy-membership.html">
      <i class="fa-solid fa-credit-card"></i> Buy Membership
      </a>
      </li>
      <li>
      <hr
      style="
      border: none;
      height: 0.5px;
      background-color: #e9ecef;
      margin: 0.5rem 0;
      width: calc(100% - 1rem);
      margin-left: auto;
      margin-right: auto;
      "
      />
      </li>
      `;

            // Insert admin items before the logout button
            dropdownMenu.insertAdjacentHTML("beforeend", adminItems);
          }
        } catch (error) {
          console.error("Error validating token:", error);
          // Redirect to login if there's an error
          window.location.href = "login.html";
        }
      }

      // Call the validateToken function when the page loads
      window.onload = validateToken;

      function processBulkCalls() {
    const fileInput = document.getElementById("file-upload");
    const selectedCategory = categorySelect.value;
    const customValue = customValueInput.value;

    // Check if file is selected
    if (fileInput.files.length === 0) {
        alert("Please upload a CSV or Excel file.");
        return;
    }

    const file = fileInput.files[0];
    const fileName = file.name.toLowerCase();

    // Set up file reading based on format
    if (fileName.endsWith(".csv")) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const text = e.target.result;
            const data = csvToArray(text);
            initiateCalls(data, selectedCategory);
        };
        reader.readAsText(file);
    } else if (fileName.endsWith(".xlsx")) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet);
            initiateCalls(json, selectedCategory);
        };
        reader.readAsArrayBuffer(file);
    } else {
        alert("Unsupported file format. Please upload a CSV or Excel file.");
    }
}

async function initiateCalls(users, selectedCategory) {
    const callCount = users.length;
    const response = await fetch(
        "https://aicalling-demo.onrender.com/api/auth/check-bulk-credit",
     //   "http://localhost:3000/api/auth/check-bulk-credit",
        {
            method: "POST",
            headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ callCount }),
        }
    );

    if (response.ok) {
        const data = await response.json();
        if (!data.vapiPhoneNumberId) {
            Swal.fire({
                icon: "error",
                title: "No Credentials Found",
                text: "No credentials found",
            });
            return;
        }

        Swal.fire({
            icon: "success",
            title: "Credits Available",
            text: `You have sufficient credits to proceed with ${callCount} calls.`,
        });

        users.forEach((user) => {
            const nameKey = Object.keys(user).find(
                (key) => key.trim().toLowerCase() === "name"
            );
            const phoneNumberKey = Object.keys(user).find(
                (key) => key.trim().toLowerCase() === "phone number"
            );
            const address = Object.keys(user).find(
                (key) => key.trim().toLowerCase() === "address"
            );

            const userName = user[nameKey];
            const addressUser = user[address]
            console.log(addressUser)
            let phoneNumber = user[phoneNumberKey];
            if (typeof phoneNumber !== "string") {
                phoneNumber = String(phoneNumber);
            }
            const formattedPhoneNumber = `+${phoneNumber.replace(/[^\d]/g, "")}`;

            // Constructing dynamic promptText based on selected category and userName
            const promptText = selectedCategory === "Home Sellers"
    ? `Greeting: "Hello ${userName || "there"}, ${addressUser ? `is this the owner of ${addressUser}?` : "are you the property owner?"} (If yes, proceed. If no, politely end the call.)\n
        Qualifying Questions:\n
        Motivation: "Can you tell me why you're considering selling your property?"\n
        Property Condition: "Can you share a bit about the property's condition, such as the roof, A/C, or recent upgrades?"\n
        Timeframe: "When are you looking to sell? Do you have a specific timeframe?"\n
        Price: "What price are you hoping to get for the property?"\n
        Additional Needs: "Is there anything specific you might need help with during the selling process?"\n
        Closing: "Thank you for sharing. I'll review this with my team and follow up soon. Have a great day!"`
    : selectedCategory === "Home Buyers"
    ? `Greeting: "Hello ${userName || "there"}, I understand you’re interested in buying a property. Is this a good time to speak?"\n
        Qualifying Questions:\n
        Budget: "Could you share your budget range for the property you’re interested in?"\n
        Property Type: "What type of property are you looking for (e.g., single-family, condo)?"\n
        Location: "Do you have a preferred location or neighborhood in mind?"\n
        Additional Requirements: "Are there any specific features or amenities you’re looking for?"\n
        Closing: "Thank you for your time. I’ll review this and follow up with some options. Have a great day!"`
    : selectedCategory === "Real Estate Investor / Wholesaler"
    ? `Greeting: "Hello ${userName || "there"}, I understand you're exploring investment opportunities in real estate. Is this a good time to speak?"\n
        Qualifying Questions:\n
        Investment Goals: "Could you tell me about your investment goals? Are you interested in long-term holds, fix-and-flips, or wholesaling?"\n
        Budget: "What is your investment budget, or do you have a specific price range in mind?"\n
        Preferred Location: "Are there any specific locations or neighborhoods you're interested in investing in?"\n
        Additional Needs: "Are there any other specific requirements or amenities you’re looking for in investment properties?"\n
        Closing: "Thank you for sharing. I'll review this with my team and follow up soon with suitable options. Have a great day!"`
    : customValue;


            const selectedLanguage = document.getElementById("language").value;
            if (!selectedLanguage) {
                Swal.fire({
                    icon: "error",
                    text: "Please select a language first",
                });
                return;
            }



            console.log(promptText)
            // Prepare callOptions for each user
            const callOptions = {
                method: "POST",
                headers: {
                    Authorization: "22576079-730d-4707-b8ab-f780113249f3",
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    name: `Bulk call to ${userName}`,
                    phoneNumberId: data.vapiPhoneNumberId,
                    customer: {
                        number: formattedPhoneNumber,
                    },
                    assistant: {
                        transcriber: {
                            provider: "deepgram",
                            model: "nova-2",
                            language: "en-AU",
                            smartFormat: false,
                        },
                        model: {
                            provider: "openai",
                            model: "gpt-4",
                            messages: [
                                {
                                    role: "system",
                                    content: promptText,
                                },
                            ],
                        },
                    },
                }),
            };

            // Initiate each call
            fetch("https://api.vapi.ai/call", callOptions)
                .then((response) => response.json())
                .then((data) => {
                    console.log(`Call to ${userName} initiated:`, data);
                    const callSid = data.id;
                    updateCredit(localStorage.getItem("token"));
                    updateCallResults(
                        userName,
                        formattedPhoneNumber,
                        "Call initiated successfully"
                    );
                    pollCallStatus(callSid, userName, formattedPhoneNumber);
                })
                .catch((error) => {
                    console.error("Error initiating call to", userName, ":", error);
                    updateCallResults(
                        userName,
                        formattedPhoneNumber,
                        "Failed to initiate call"
                    );
                });
        });
    } else {
        Swal.fire({
            icon: "error",
            title: "No Credits Available",
            text: "No Credits Available",
        });
    }
}

      function csvToArray(str, delimiter = ",") {
        const headers = str.slice(0, str.indexOf("\n")).split(delimiter);
        const rows = str.slice(str.indexOf("\n") + 1).split("\n");
        return rows.map(function (row) {
          const values = row.split(delimiter);
          const el = headers.reduce(function (object, header, index) {
            object[header] = values[index];
            return object;
          }, {});
          return el;
        });
      }

      const updateCredit = async (token) => {
        try {
          // Fetch the update-credit API endpoint
          const response = await fetch(
           //  "http://localhost:3000/api/auth/update-credit",
           "https://aicalling-demo.onrender.com/api/auth/update-credit",
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          // Check if the response is successful
          if (response.ok) {
            const data = await response.json();
            console.log("Credit update response:", data);
          } else if (response.status === 403) {
          } else {
            const errorData = await response.json();
          }
        } catch (error) {
          console.error("Error updating credits:", error);
        }
      };

      function arrayBufferToBase64(buffer) {
        let binary = "";
        const bytes = new Uint8Array(buffer);
        bytes.forEach((b) => (binary += String.fromCharCode(b)));
        return window.btoa(binary);
      }

      function pollCallStatus(callSid, name, phoneNumber) {
        const pollInterval = 30000; // 30 seconds
        const maxRetries = 20; // Maximum number of retries

        function checkStatus(retries) {
          fetch(`https://api.vapi.ai/call/${callSid}`, {
            method: "GET",
            headers: {
              Authorization: "Bearer 22576079-730d-4707-b8ab-f780113249f3",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              console.log(`Status for call ${callSid}:`, data);
              const status = data.status; // Call status
              const endedReason = data.endedReason; // Reason why call ended

              if (status === "ended") {
                // Send SMS only if call has ended
                sendSMS(name, phoneNumber, endedReason);
                scheduleAppointment();
                // sendEmail("madhavbansal356@gmail.com", "Testing", "Hi, This mail is for testing purpose")
              } else if (retries < maxRetries) {
                setTimeout(() => checkStatus(retries + 1), pollInterval);
              } else {
                console.log(`Call ${callSid} did not complete in time.`);
              }
            })
            .catch((error) => {
              console.error("Error checking call status:", error);
              if (retries < maxRetries) {
                setTimeout(() => checkStatus(retries + 1), pollInterval);
              }
            });
        }

        checkStatus(0);
      }

      function sendSMS(name, phoneNumber, endedReason) {
        const message = `Hello ${name}, Thank you for your time. We will schedule a meeting with you and provide you with an update soon. Reason for ending: ${
          endedReason || "Not provided"
        }.`;

        //  fetch("https://aicalling-osdb.onrender.com/api/messages/send-sms", {
        // fetch("http://localhost:3000/api/messages/send-sms", {
        fetch("https://aicalling-demo.onrender.com/api/messages/send-sms", {
          // Adjusted the endpoint to match the route path
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            toNumber: phoneNumber,
            message: message,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`Failed to send SMS: ${response.statusText}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("SMS sent successfully:", data);
          })
          .catch((error) => {
            console.error("Error sending SMS:", error.message);
          });
      }

      function updateCallResults(name, phoneNumber, status) {
        const resultsDiv = document.getElementById("call-results");
        const result = document.createElement("div");
        result.innerHTML = `Call to ${name} (${phoneNumber}): ${status}`;
        resultsDiv.appendChild(result);
      }

      async function getTranscript() {
        try {
          const response = await fetch("https://api.vapi.ai/call", options);
          const data = await response.json();

          if (data.length > 0) {
            // Find the call with the most recent 'updatedAt' timestamp
            const latestCall = data.reduce((latest, call) => {
              return new Date(call.updatedAt) > new Date(latest.updatedAt)
                ? call
                : latest;
            });

            const latestTranscript = latestCall.transcript;

            // Print the latest transcript
            console.log("Transcript:", latestTranscript);

            return latestTranscript;
          } else {
            console.log("No transcripts available.");
            return null;
          }
        } catch (err) {
          console.error(err);
          return null;
        }
      }

      async function scheduleAppointment() {
        const demoTranscript = await getTranscript(); // Wait for the transcript to be fetched

        if (!demoTranscript) {
          console.error("Failed to retrieve transcript.");
          return;
        }

        console.log("Latest Transcript:", demoTranscript);

        // First, make a POST request to the `/api/demo-transcript` endpoint
        //fetch('https://aicalling-osdb.onrender.com/api/demo-transcript', {
        //  fetch("http://localhost:3000/api/demo-transcript", {
        fetch("https://aicalling-demo.onrender.com/api/demo-transcript", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ transcript: demoTranscript }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                "Network response was not ok " + response.statusText
              );
            }
            return response.json();
          })
          .then((data) => {
            console.log("Success:", data);

            // Extract variables from the response
            const { name, email, phone, date, time } = data;

            // Log extracted fields to check if they are correct
            console.log("Extracted Info:", { name, email, phone, date, time });

            // Convert the date and time into ISO format
            let appointmentDateTime;
            try {
              // Check if date and time are valid
              if (date && time) {
                // Convert date format if necessary
                const formattedDate = date.replace(
                  /(\d{4})\/(\d{2})\/(\d{2})/,
                  "$1-$2-$3"
                );
                appointmentDateTime = new Date(`${formattedDate}T${time}:00`);

                // Check if the date is valid
                if (isNaN(appointmentDateTime.getTime())) {
                  throw new Error("Invalid date/time value");
                }
              } else {
                throw new Error("Date or time missing");
              }
            } catch (error) {
              console.error("Error with date/time conversion:", error);
              Swal.fire({
                icon: "error",
                title: "Invalid Date/Time",
                text: "The provided date or time is invalid. Please check the format.",
              });
              return;
            }

            // Prepare event data using the extracted information
            const eventData = {
              summary: `Meeting with ${name}`,
              location: "123 Main St, Anytown, USA",
              description: `Appointment with ${name}. Contact: ${phone}. Email: ${email}`,
              startDateTime: appointmentDateTime.toISOString(),
              endDateTime: new Date(
                appointmentDateTime.getTime() + 60 * 60 * 1000
              ).toISOString(), // 1 hour duration
            };

            // Send event data to your event scheduling endpoint
            // return fetch("https://aicalling-osdb.onrender.com/calendar/events", {
            //   return fetch("http://localhost:3000/calendar/event", {
            return fetch("https://aicalling-demo.onrender.com/calendar/event", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(eventData),
            });
          })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                "Network response was not ok " + response.statusText
              );
            }
            return response.json();
          })
          .then((data) => {
            console.log("Event created successfully:", data);
            Swal.fire({
              icon: "success",
              title: "Appointment Scheduled",
              text: "The appointment was scheduled successfully.",
            });
          })
          .catch((error) => {
            console.error(
              "There was a problem with the fetch operation:",
              error
            );
            Swal.fire({
              icon: "error",
              title: "Failed to Schedule Appointment",
              text: "An error occurred while scheduling the appointment. Please try again.",
            });
          });
      }

      // Add this function to parse CSV data
      function parseCSVData(csvText) {
        const lines = csvText.split('\n');
        const headers = lines[0].split(',').map(header => header.trim());
        const results = [];

        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue; // Skip empty lines
          
          const currentLine = lines[i].split(',').map(field => field.trim());
          const entry = {};
          
          headers.forEach((header, index) => {
            entry[header.toLowerCase()] = currentLine[index];
          });
          
          results.push(entry);
        }
        
        return results;
      }

      // Modify your file upload handler
      document.getElementById('csvFile').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();

        reader.onload = async function(event) {
          try {
            const csvData = parseCSVData(event.target.result);
            
            // Process each row from CSV
            for (const row of csvData) {
              const callData = {
                phoneNumber: row.phone || row.phonenumber || row['phone number'],
                userName: row.name || row.username || row.user,
                email: row.email || '',
                company: row.company || row.organization || '',
                purpose: row.purpose || row.reason || '',
                // Add any other fields you expect from the CSV
              };

              // Make API call for each entry
              const response = await fetch("https://aicalling-demo.onrender.com/api/auth/make-call", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
                body: JSON.stringify(callData),
              });

              if (!response.ok) {
                throw new Error(`Failed to process call for ${callData.phoneNumber}`);
              }
            }
            
            alert('Bulk calls processed successfully!');
          } catch (error) {
            console.error('Error processing CSV:', error);
            alert('Error processing CSV file: ' + error.message);
          }
        };

        reader.readAsText(file);
      });
    </script>
  </body>
</html>
