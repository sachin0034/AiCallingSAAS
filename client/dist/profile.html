<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Mazer Admin Dashboard</title>

    <link rel="stylesheet" href="assets/css/bootstrap.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/vendors/iconly/bold.css" />
    <link
      rel="stylesheet"
      href="assets/vendors/perfect-scrollbar/perfect-scrollbar.css"
    />
    <link
      rel="stylesheet"
      href="assets/vendors/bootstrap-icons/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="assets/css/app.css" />
    <link
      rel="shortcut icon"
      href="assets/images/favicon.svg"
      type="image/x-icon"
    />
    <style>
      .profile-image-container {
        position: relative;
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }

      .profile-image {
        border-radius: 50%;
        width: 150px;
        height: 150px;
        border: 5px solid #fff;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        object-fit: cover;
      }

      .edit-icon {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background-color: #f8f9fa;
        border-radius: 50%;
        padding: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .edit-icon:hover {
        background-color: #e0e0e0;
      }

      #uploadForm {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #uploadForm button {
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 8px 16px;
        cursor: pointer;
        margin-top: 15px;
        transition: background-color 0.3s;
        padding: 10px;
        margin: 10px;
      }

      #uploadForm button:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body style="background-color: #eee" onload="validateToken()">
    <section style="background-color: #f7f7f7">
      <div class="container py-5">
        <div class="row justify-content-center mb-4">
          <div class="col-lg-8">
            <nav
              aria-label="breadcrumb"
              class="bg-white shadow-sm rounded-3 p-3"
            >
              <ol class="breadcrumb mb-0 justify-content-center">
                <li
                  class="breadcrumb-item active text-center"
                  aria-current="page"
                >
                  <h4 class="mb-0">Profile</h4>
                </li>
              </ol>
            </nav>
          </div>
        </div>

        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="card mb-4 shadow-sm border-0">
              <div class="profile-image-container">
                <img
                  id="profileImage"
                  src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3.webp"
                  alt="avatar"
                  class="profile-image"
                />
                <img
                  src="https://img.icons8.com/material-rounded/24/000000/edit--v1.png"
                  class="edit-icon"
                  id="editIcon"
                  alt="Edit"
                />
              </div>

              <form id="uploadForm" enctype="multipart/form-data">
                <input
                  type="file"
                  id="imageInput"
                  name="image"
                  style="display: none"
                  accept="image/*"
                />
                <p id="fileName" style="margin-top: 10px"></p>

                <button type="submit">Update Profile Image</button>
              </form>
            </div>
          </div>

          <div class="col-lg-8">
            <div class="card mb-4 shadow-sm border-0">
              <div class="card-body p-4">
                <!-- Full Name -->
                <div class="row mb-3">
                  <div class="col-sm-3">
                    <p class="mb-0 text-muted">Full Name</p>
                  </div>
                  <div class="col-sm-9 d-flex align-items-center">
                    <p
                      class="text-dark mb-0"
                      id="name"
                      onclick="openEdit('name')"
                    >
                      Loading...
                    </p>
                    <i
                      class="bi bi-pencil ms-2 text-muted"
                      onclick="openEdit('name')"
                      style="cursor: pointer"
                    ></i>
                  </div>
                </div>
                <hr />

                <!-- Email -->
                <div class="row mb-3">
                  <div class="col-sm-3">
                    <p class="mb-0 text-muted">Email</p>
                  </div>
                  <div class="col-sm-9 d-flex align-items-center">
                    <p class="text-dark mb-0" id="email">Loading...</p>
                  </div>
                </div>
                <hr />

                <!-- Phone -->
                <div class="row mb-3">
                  <div class="col-sm-3">
                    <p class="mb-0 text-muted">Phone</p>
                  </div>
                  <div class="col-sm-9 d-flex align-items-center">
                    <p class="text-dark mb-0" id="phone">Loading...</p>
                    <i
                      class="bi bi-pencil ms-2 text-muted"
                      onclick="openEdit('phone')"
                      style="cursor: pointer"
                    ></i>
                  </div>
                </div>

                <hr />
                <div class="row mb-3">
                  <div class="col-sm-3">
                    <p class="mb-0 text-muted">Change Password</p>
                  </div>
                  <div class="col-sm-9 d-flex align-items-center">
                    <i
                      class="bi bi-pencil ms-2 text-muted"
                      onclick="openEdit('password')"
                      style="cursor: pointer"
                    ></i>
                  </div>
                </div>
                <hr />
                <div class="row mb-3">
                  <div class="col-sm-3">
                    <p class="mb-0 text-muted">Credit Usage</p>
                  </div>
                  <div class="col-sm-9 d-flex align-items-center">
                    <p class="text-dark mb-0" id="credit">Loading...</p>
                  </div>
                </div>
                <hr />

                <!-- Go to Dashboard Button -->
                <div class="text-center">
                  <a
                    href="index.html"
                    class="btn btn-primary mt-3"
                    style="padding: 10px 30px; font-size: 1rem"
                    >Go to Dashboard</a
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Modal -->
      <div
        class="modal fade"
        id="editModal"
        tabindex="-1"
        aria-labelledby="editModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel">Edit</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <input
                type="text"
                class="form-control"
                id="editInput"
                placeholder="Enter new value"
              />
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button
                type="button"
                class="btn btn-primary"
                onclick="submitEdit()"
              >
                Save changes
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script src="loader.js"></script>
    <script>
      let editField = "";

      // Function to open the modal for editing
      function openEdit(field) {
        editField = field;

        // If the field is not 'password', set the input value to the current value from the element
        if (field !== "password") {
          const value = document.getElementById(field).innerText;
          document.getElementById("editInput").value = value;
        } else {
          // For password, leave the input blank as we don't show the current password
          document.getElementById("editInput").value = "";
          document.getElementById("editInput").placeholder =
            "Enter new password";
        }

        // Show the modal
        const editModal = new bootstrap.Modal(
          document.getElementById("editModal")
        );
        editModal.show();
      }

      async function submitEdit() {
        const newValue = document.getElementById("editInput").value.trim();
        console.log(newValue);
        if (!newValue) {
          alert("Please enter a valid value.");
          return;
        }
        console.log(newValue);
        const targetElement = document.getElementById(editField);

        if (targetElement) {
          targetElement.innerText = newValue;
        } else {
          console.error(`Element with ID '${editField}' not found.`);
        }

        showLoader();
        // Save data to the backend
        try {
          const response = await fetch(
           // "http://localhost:3000/api/auth/update-profile",
            "https://aicalling-demo.onrender.com/api/auth/update-profile",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: JSON.stringify({ field: editField, value: newValue }),
            }
          );
          hideLoader();
          if (!response.ok) {
            throw new Error("Failed to update");
          }

          console.log(response);
          alert("Profile updated successfully.");
          const editModal = bootstrap.Modal.getInstance(
            document.getElementById("editModal")
          );
          editModal.hide();
        } catch (error) {
          console.error("Error updating profile:", error);
          alert("Error updating profile. Please try again later.");
        }
      }

      async function validateToken() {
        const token = localStorage.getItem("token");

        if (!token) {
          window.location.href = "login.html";
          return;
        }
        showLoader();

        try {
          const response = await fetch(
           // "http://localhost:3000/api/auth/validate-profile",
              "https://aicalling-demo.onrender.com/api/auth/validate-profile",
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            }
          );
          hideLoader();
          if (!response.ok) {
            throw new Error("Token validation failed");
          }

          const data = await response.json();
          if (!data.valid) {
            window.location.href = "login.html";
          } else {
            populateProfileForm(data.data);
          }
        } catch (error) {
          console.error("Error validating token:", error);
          window.location.href = "login.html";
        }
      }
      function arrayBufferToBase64(buffer) {
        let binary = "";
        const bytes = new Uint8Array(buffer);
        bytes.forEach((b) => (binary += String.fromCharCode(b)));
        return window.btoa(binary);
      }
      function populateProfileForm(data) {
        document.getElementById("name").innerText = data.name;
        document.getElementById("email").innerText = data.email;
        document.getElementById("phone").innerText = data.phone;

        if (data.profileImage && data.profileImage.buffer) {
          const base64String = arrayBufferToBase64(
            data.profileImage.buffer.data
          );
          const mimeType = data.profileImage.contentType;

          const newImageUrl = `data:${mimeType};base64,${base64String}`;
          document.getElementById("profileImage").src = newImageUrl;
        }
        if (data.credit >= 0) {
          document.getElementById("credit").innerText = data.credit;
        } else if (data.credits >= 0) {
          document.getElementById("credit").innerText = data.credits;
        } else {
          document.getElementById("credit").innerText = "Admin";
        }
      }

      document.getElementById("editIcon").addEventListener("click", () => {
        document.getElementById("imageInput").click();
      });

      document.getElementById("imageInput").addEventListener("change", (e) => {
        const fileInput = e.target;
        const fileNameDisplay = document.getElementById("fileName");
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          fileNameDisplay.textContent = `Selected file: ${file.name}`;

          const reader = new FileReader();
          reader.onload = function (event) {
            document.getElementById("profileImage").src = event.target.result;
          };
          reader.readAsDataURL(file);
        } else {
          fileNameDisplay.textContent = "";
        }
      });

      document
        .getElementById("uploadForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const fileInput = document.getElementById("imageInput");
          if (fileInput.files.length === 0) {
            alert("Please select an image to upload.");
            return;
          }

          const formData = new FormData();
          formData.append("image", fileInput.files[0]);
          showLoader()
          try {
            const response = await fetch(
          //   "http://localhost:3000/api/auth/updateProfilePic",
              "https://aicalling-demo.onrender.com/api/auth/updateProfilePic",
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
                body: formData,
              }
            );

            hideLoader()
            const result = await response.json();
            if (result.status === "ok") {
              alert("Profile image updated successfully");
              const newImageUrl = URL.createObjectURL(fileInput.files[0]);
              document.getElementById("profileImage").src = newImageUrl;
            } else {
              alert(`Error: ${result.message}`);
            }
          } catch (error) {
            console.error("Error uploading profile image:", error);
            alert("An error occurred while updating the profile image.");
          }
        });
    </script>
  </body>
</html>
